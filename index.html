<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Bison</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="img/bilboicon01.png" type="image/png">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>

<body>
  <h1>Verse of the Day</h1>

  <!-- Date & optional time -->
  <div id="datetime">
    <p id="date"></p>
    <!--<p id="time"></p>--> <!-- uncomment if you want live time -->
  </div>

  <script>
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const date = now.toLocaleDateString(undefined, options);
      const time = now.toLocaleTimeString();

      document.getElementById("date").textContent = date;
      document.getElementById("time").textContent = time;
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>

  <!-- Verse of the Day -->
  <div id="verse" class="fade-in"></div>

  <script>
    async function loadVerse() {
      try {
        let response = await fetch("https://beta.ourmanna.com/api/v1/get/?format=text");
        let verse = await response.text();
        document.getElementById("verse").innerText = verse;
      } catch (e) {
        document.getElementById("verse").innerText = "Verse of the Day unavailable.";
      }
    }
    loadVerse();
  </script>

  <!-- Bilbo Image -->
  <img src="img/Bilbo_The_Bison777.png" class="centered-image">



<!-- Discuss Verse Button -->
<button id="connectBtn">Discuss Verse</button>

<!-- Container for all remote audio -->
<div id="audioContainer"></div>

<script>
  const ROOM_ID = "BibleBisonRoom";
  const peers = {};
  let peer;
  let localStream;
  let isHub = false;

  function initPeer() {
    // Try to claim the ROOM_ID (be the hub)
    let hubCandidate = new Peer(ROOM_ID);

    hubCandidate.on("open", id => {
      if (id === ROOM_ID) {
        peer = hubCandidate;
        setupPeer(true);  // hub setup
      }
    });

    // If ROOM_ID already taken, become participant
    hubCandidate.on("error", err => {
      if (err.type === "unavailable-id") {
        console.log("Room already exists, joining as participant...");
        peer = new Peer(); // random ID
        setupPeer(false);  // participant setup
      }
    });
  }

  function setupPeer(asHub) {
    isHub = asHub;

    console.log("I am " + (isHub ? "the HUB" : "a participant"));

    peer.on("open", id => {
      const idDiv = document.createElement("p");
      idDiv.innerText = "Your ID: " + id + (isHub ? " (Hub)" : "");
      document.body.appendChild(idDiv);
    });

    // Answer incoming calls
    peer.on("call", call => {
      if (localStream) {
        call.answer(localStream);
        call.on("stream", remoteStream => {
          addAudioStream(call.peer, remoteStream);
        });
      }
    });

    // Hub: forward join messages
    if (isHub) {
      peer.on("connection", conn => {
        conn.on("data", data => {
          if (data.join) {
            console.log("Broadcasting new user:", data.join);
            Object.values(peer.connections).forEach(conns => {
              conns.forEach(c => {
                if (c.peer !== data.join) {
                  c.send({ join: data.join });
                }
              });
            });
          }
        });
      });
    }
  }

  document.getElementById("connectBtn").onclick = async () => {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    if (!isHub) {
      const conn = peer.connect(ROOM_ID);
      conn.on("open", () => {
        conn.send({ join: peer.id });
      });

      conn.on("data", data => {
        if (data.join && data.join !== peer.id) {
          connectToNewUser(data.join, localStream);
        }
      });
    }
  };

  function connectToNewUser(userId, stream) {
    if (peers[userId]) return;
    const call = peer.call(userId, stream);
    call.on("stream", remoteStream => {
      addAudioStream(userId, remoteStream);
    });
    call.on("close", () => {
      removeAudioStream(userId);
    });
    peers[userId] = call;
  }

  function addAudioStream(id, stream) {
    let audioContainer = document.getElementById("audioContainer");
    let audio = document.createElement("audio");
    audio.id = "audio-" + id;
    audio.srcObject = stream;
    audio.autoplay = true;
    audioContainer.appendChild(audio);
  }

  function removeAudioStream(id) {
    const audio = document.getElementById("audio-" + id);
    if (audio) audio.remove();
  }

  initPeer();
</script>




</body>
</html>
