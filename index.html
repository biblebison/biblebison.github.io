<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Bison</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="img/bilboicon01.png" type="image/png">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>

<body>
  <h1>Verse of the Day</h1>

  <!-- Date & optional time -->
  <div id="datetime">
    <p id="date"></p>
    <!--<p id="time"></p>--> <!-- uncomment if you want live time -->
  </div>

  <script>
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const date = now.toLocaleDateString(undefined, options);
      const time = now.toLocaleTimeString();

      document.getElementById("date").textContent = date;
      document.getElementById("time").textContent = time;
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>

  <!-- Verse of the Day -->
  <div id="verse" class="fade-in"></div>

  <script>
    async function loadVerse() {
      try {
        let response = await fetch("https://beta.ourmanna.com/api/v1/get/?format=text");
        let verse = await response.text();
        document.getElementById("verse").innerText = verse;
      } catch (e) {
        document.getElementById("verse").innerText = "Verse of the Day unavailable.";
      }
    }
    loadVerse();
  </script>

  <!-- Bilbo Image -->
  <img src="img/Bilbo_The_Bison777.png" class="centered-image">



<!-- Discuss Verse Button -->
<button id="connectBtn">Discuss Verse</button>

<!-- Container for all remote audio -->
<div id="audioContainer"></div>

<script>
  const ROOM_ID = "BibleBisonRoom";
  const peers = {};
  let peer;
  let localStream;
  let isHub = false;
  let hubId = ROOM_ID;
  
  // Initialize everything
  async function initPeer() {
    await getLocalStream();
    tryBecomeHub();
  }
  
  // Get microphone access
  async function getLocalStream() {
    if (!localStream) {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }
  }
  
  // Try to become the hub
  function tryBecomeHub() {
    let hubCandidate = new Peer(ROOM_ID);
  
    hubCandidate.on("open", id => {
      if (id === ROOM_ID) {
        peer = hubCandidate;
        hubId = id;
        setupPeer(true);
        console.log("I am the HUB!");
      }
    });
  
    hubCandidate.on("error", err => {
      if (err.type === "unavailable-id") {
        console.log("Hub exists, joining as participant...");
        peer = new Peer(); // random ID
        setupPeer(false);
      }
    });
  }
  
  // Setup peer (both hub and participant)
  function setupPeer(asHub) {
    isHub = asHub;
  
    peer.on("open", id => {
      console.log("My PeerJS ID:", id, isHub ? "(Hub)" : "(Participant)");
      const idDiv = document.createElement("p");
      idDiv.innerText = "Your ID: " + id + (isHub ? " (Hub)" : "");
      document.body.appendChild(idDiv);
    });
  
    // Answer incoming calls
    peer.on("call", call => {
      call.answer(localStream);
      call.on("stream", remoteStream => addAudioStream(call.peer, remoteStream));
    });
  
    // Hub logic
    if (isHub) {
      peer.on("connection", conn => {
        conn.on("data", data => {
          if (data.join) {
            console.log("Broadcasting new user:", data.join);
            // Inform all peers about the new user
            Object.values(peer.connections).forEach(conns => {
              conns.forEach(c => {
                if (c.peer !== data.join) c.send({ join: data.join });
              });
            });
          }
          if (data.leave) {
            console.log("User left:", data.leave);
            removeAudioStream(data.leave);
          }
        });
  
        conn.on("close", () => console.log("A participant disconnected"));
      });
    } else {
      // Participant logic: connect to hub
      connectToHub();
    }
  }
  
  // Connect participant to hub
  function connectToHub() {
    if (!peer) return;
  
    const conn = peer.connect(hubId);
  
    conn.on("open", () => {
      conn.send({ join: peer.id });
    });
  
    conn.on("data", data => {
      if (data.join && data.join !== peer.id) {
        connectToNewUser(data.join, localStream);
      }
    });
  
    conn.on("close", () => {
      console.log("Hub disconnected! Attempting to become new hub...");
      setTimeout(tryBecomeHub, Math.random() * 500 + 200); // Randomized delay to avoid conflicts
    });
  
    conn.on("error", err => {
      console.log("Error connecting to hub:", err);
      setTimeout(tryBecomeHub, Math.random() * 500 + 200);
    });
  
    // Clean up on leave
    window.addEventListener("beforeunload", () => {
      if (conn.open) conn.send({ leave: peer.id });
    });
  }
  
  // Connect to a new user (peer-to-peer audio)
  function connectToNewUser(userId, stream) {
    if (peers[userId]) return;
  
    const call = peer.call(userId, stream);
    call.on("stream", remoteStream => addAudioStream(userId, remoteStream));
    call.on("close", () => removeAudioStream(userId));
  
    peers[userId] = call;
  }
  
  // Add audio stream element
  function addAudioStream(id, stream) {
    let audioContainer = document.getElementById("audioContainer");
    if (document.getElementById("audio-" + id)) return; // avoid duplicates
    let audio = document.createElement("audio");
    audio.id = "audio-" + id;
    audio.srcObject = stream;
    audio.autoplay = true;
    audioContainer.appendChild(audio);
  }
  
  // Remove audio stream element
  function removeAudioStream(id) {
    const audio = document.getElementById("audio-" + id);
    if (audio) audio.remove();
  }
  
  // Button click: join the room
  document.getElementById("connectBtn").onclick = async () => {
    if (!localStream) await getLocalStream();
    if (!isHub && peer) connectToHub();
  };
  
  initPeer();
  </script>  



</body>
</html>
