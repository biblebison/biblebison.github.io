<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bible Bison</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="img/bilboicon01.png" type="image/png">
</head>

<body>
  <h1>Verse of the Day</h1>

  <div id="datetime">
    <p id="date"></p>
    <!--<p id="time"></p>--> <!-- Time is optional, uncomment if needed -->
  </div>
  
  <!--Script below updates date and can do time as well-->
  <script>
    function updateDateTime() {
      const now = new Date();
  
      // Date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const date = now.toLocaleDateString(undefined, options);
  
      // Time
      const time = now.toLocaleTimeString();
  
      document.getElementById("date").textContent = date;
      document.getElementById("time").textContent = time;
    }
  
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>

  <div id="verse" class="fade-in"></div>

  <!--Script below loads the verse of the day-->
  <script>
    async function loadVerse() {
      try {
        let response = await fetch("https://beta.ourmanna.com/api/v1/get/?format=text");
        let verse = await response.text();
        document.getElementById("verse").innerText = verse;
      } catch (e) {
        document.getElementById("verse").innerText = "Verse of the Day unavailable.";
      }
    }
    loadVerse();
  </script>

  <img src="img/Bilbo_The_Bison777.png" class="centered-image">

  <!-- ✅ New Connect Button -->
  <button id="connectBtn">Connect</button>
  <p id="status"></p>
  <audio id="remoteAudio" autoplay></audio>

  <!-- ✅ WebRTC + Socket.io Client -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const connectBtn = document.getElementById("connectBtn");
    const statusEl = document.getElementById("status");
    const remoteAudio = document.getElementById("remoteAudio");

    let localStream;
    let peerConnection;
    const socket = io();

    // STUN server config
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    connectBtn.onclick = async () => {
      statusEl.textContent = "Looking for someone to connect with...";
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      peerConnection = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = (event) => {
        remoteAudio.srcObject = event.streams[0];
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", event.candidate);
        }
      };

      socket.emit("join");

      socket.on("offer", async (offer) => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("answer", answer);
      });

      socket.on("answer", async (answer) => {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      });

      socket.on("ice-candidate", async (candidate) => {
        try {
          await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (err) {
          console.error("Error adding received ice candidate", err);
        }
      });

      // Create offer if first peer
      socket.on("ready", async () => {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit("offer", offer);
      });
    };
  </script>

</body>
</html>
